# WebServ Configuration File
# Simplified configuration following subject requirements

# First server block - Main website
server {
	# Listen on interface:port (mandatory)
	listen 127.0.0.1:8080;
	
	# Root directory for this server (mandatory)
	root ./www;
	
	# Default index file
	index index.html;
	
	# Directory listing (on/off)
	autoindex on;
	
	# Maximum allowed size for client request body (in bytes)
	client_max_body_size 1048576;
	
	# Default error pages
	error_page 404 /errors/404.html;
	error_page 500 502 503 504 /errors/50x.html;
	
	# Root location - default settings
	location / {
		# Accepted HTTP methods for this route
		allow_methods GET HEAD POST;
	}
	
	# Static files location
	location /static {
		root ./www;
		allow_methods GET;
		autoindex off;
	}
	
	# File upload location
	location /uploads {
		root ./www/uploads;
		allow_methods GET HEAD POST PUT DELETE;
		
		# Directory where uploaded files will be stored
		upload_store ./www/uploads;
		
		# Specific body size limit for uploads (10KB for testing)
		client_max_body_size 10240;
	}
	
	# Unlimited upload location for large files
	location /uploads/large {
		root ./www/uploads;
		allow_methods GET HEAD POST PUT DELETE;
		upload_store ./www/uploads;
		
		# 0 means unlimited
		client_max_body_size 0;
	}
		
	# HTTP redirection example
	location /old-page {
		return 301 /new-page;
	}
	
	# Another redirection
	location /redirect {
		return 302 /;
	}
}

# Second server block - Alternative port
server {
	listen 127.0.0.1:8081;
	
	root ./www;
	index index.html;
	autoindex off;
	
	client_max_body_size 2097152;  # 2MB
	
	error_page 404 /404.html;
	error_page 500 /500.html;
	
	location / {
		allow_methods GET POST DELETE;
	}
	
	# API endpoint example
	location /api {
		root ./www;
		allow_methods GET POST DELETE;
	}
}

# Third server block - Different interface
server {
	listen 0.0.0.0:8082;
	
	root ./www/site2;
	index home.html;
	autoindex off;
	
	client_max_body_size 5242880;  # 5MB
	
	# Custom error pages for this server
	error_page 403 /errors/403.html;
	error_page 404 /errors/404.html;
	error_page 500 /errors/500.html;
	
	location / {
		allow_methods GET;
	}
	
	# Images directory
	location /images {
		root ./www/site2;
		allow_methods GET;
	}
	
	# Downloads with directory listing
	location /downloads {
		root ./www/site2;
		allow_methods GET;
	}
	
	# Upload endpoint
	location /submit {
		root ./www/site2;
		allow_methods POST DELETE;
		upload_store ./www/site2/submissions;
		autoindex on;
	}
}

# Fourth server block - subject tester configuration
server {
	listen 127.0.0.1:8084;
	
	root ./www;
	index index.html;
	autoindex off;
	
	client_max_body_size 150;
	
	# Default error pages
	error_page 404 /errors/404.html;
	error_page 500 502 503 504 /errors/50x.html;
	
	# / must answer to GET request ONLY
	location / {
		allow_methods GET;
	}
	
	# /put_test/* must answer to PUT request and save files
	location /put_test {
		root ./www/put_test;
		allow_methods PUT;
		upload_store ./www/put_test;
	}
	
	# /post_body must answer anything to POST request with a maxBody of 100
	location /post_body {
		allow_methods POST;
		client_max_body_size 100;
	}
	
	# /directory/ must answer to GET request
	# root would be YoupiBanane
	# if no file requested, search for youpi.bad_extension
	# .bla files must be handled by CGI
	# if index not found, return 404 (autoindex off)
	location /directory {
		root ./www/YoupiBanane;
		allow_methods GET POST;
		index youpi.bad_extension;
		autoindex off;
		
		# CGI for .bla extension using ubuntu_cgi_tester
		cgi_path ./cgi-exec/ubuntu_cgi_tester;
		cgi_ext .bla;
		client_max_body_size 0;
	}
	
	# CGI execution for PHP and Python files
	location /cgi-bin {
		root ./www/cgi-bin;
		allow_methods GET POST;
		cgi_path /usr/bin/php-cgi;
		cgi_ext .php;
	}
	
	location .py {
		root ./www;
		allow_methods GET POST;
		cgi_path /usr/bin/python3;
		cgi_ext .py;
	}

	# File upload location
	location /uploads {
		root ./www/uploads;
		allow_methods GET HEAD POST PUT DELETE;
		upload_store ./www/uploads;
	}
}